<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Nuheat Hanger – PayPal Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #0f172a;
      color: #e2e8f0;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    main {
      width: min(960px, 100%);
      padding: 32px 24px 48px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 1.875rem;
      margin-bottom: 0.5rem;
    }

    h2 {
      font-size: 1.35rem;
      margin-bottom: 0.75rem;
    }

    p.description {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #cbd5f5;
      max-width: 60ch;
    }

    section {
      margin-top: 1.5rem;
    }

    section[hidden] {
      display: none !important;
    }

    form {
      display: grid;
      gap: 12px;
      background-color: rgba(15, 23, 42, 0.72);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(12px);
    }

    label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      font-size: 0.9rem;
      gap: 6px;
    }

    input,
    select,
    button {
      font: inherit;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background-color: rgba(15, 23, 42, 0.45);
      color: inherit;
      transition: border-color 0.2s ease, background-color 0.2s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #38bdf8;
      background-color: rgba(15, 23, 42, 0.75);
    }

    button {
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(135deg, #38bdf8, #22d3ee);
      color: #0f172a;
      border: none;
      margin-top: 8px;
    }

    button.secondary {
      background: rgba(148, 163, 184, 0.25);
      color: inherit;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status,
    .login-status {
      margin-top: 16px;
      min-height: 20px;
      font-size: 0.95rem;
    }

    pre {
      margin-top: 20px;
      padding: 20px;
      background-color: rgba(15, 23, 42, 0.55);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .response-meta {
      margin-top: 24px;
      display: grid;
      gap: 6px;
      font-size: 0.95rem;
    }

    .panel {
      margin-top: 1.75rem;
    }

    .panel:first-of-type {
      margin-top: 0;
    }

    .transactions-nav {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .transactions-nav button {
      min-width: 130px;
    }

    .transactions-output {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .transactions-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .transaction-card {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: 16px;
      padding: 20px 22px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.45);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .transaction-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    .transaction-card__title {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 600;
    }

    .transaction-status-badge {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      background: rgba(148, 163, 184, 0.25);
      color: #e2e8f0;
      white-space: nowrap;
    }

    .transaction-status-badge--s {
      background: rgba(34, 197, 94, 0.18);
      color: #4ade80;
    }

    .transaction-status-badge--p,
    .transaction-status-badge--pending {
      background: rgba(250, 204, 21, 0.18);
      color: #facc15;
    }

    .transaction-status-badge--d,
    .transaction-status-badge--f,
    .transaction-status-badge--failed,
    .transaction-status-badge--denied {
      background: rgba(248, 113, 113, 0.18);
      color: #f87171;
    }

    .transaction-status-badge--c,
    .transaction-status-badge--cancelled,
    .transaction-status-badge--v,
    .transaction-status-badge--voided {
      background: rgba(148, 163, 184, 0.25);
      color: #cbd5f5;
    }

    .transaction-card__amount {
      font-size: 1.65rem;
      font-weight: 700;
      margin: 0;
      color: #38bdf8;
    }

    .transaction-card__subheader {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.85rem;
      color: #94a3b8;
    }

    .transaction-card__section {
      display: grid;
      gap: 8px;
    }

    .transaction-card__section-title {
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-weight: 600;
      color: #94a3b8;
    }

    .transaction-card__section-content {
      font-size: 0.92rem;
      display: grid;
      gap: 4px;
    }

    .transaction-card__meta {
      display: grid;
      gap: 6px;
      margin: 0;
    }

    .transaction-card__meta-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 0.9rem;
    }

    .transaction-card__meta-label {
      color: #94a3b8;
      font-weight: 600;
    }

    .transaction-card__meta-value {
      text-align: right;
      word-break: break-word;
    }

    .transaction-card__items {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      border-radius: 12px;
      overflow: hidden;
    }

    .transaction-card__items thead {
      background: rgba(148, 163, 184, 0.14);
    }

    .transaction-card__items th,
    .transaction-card__items td {
      padding: 6px 10px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      text-align: left;
    }

    .transaction-card__items td {
      color: #e2e8f0;
    }

    .transaction-card__footer {
      display: grid;
      gap: 2px;
      font-size: 0.85rem;
      color: #94a3b8;
    }

    .transactions-raw {
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.45);
      padding: 12px 16px;
    }

    .transactions-raw > summary {
      cursor: pointer;
      font-weight: 600;
      color: #94a3b8;
    }

    .transactions-raw[open] > pre {
      margin-top: 16px;
    }

    .transaction-empty {
      padding: 28px;
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.35);
      text-align: center;
      color: #94a3b8;
      background: rgba(15, 23, 42, 0.35);
    }

    .toolbar {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-bottom: 12px;
    }

    @media (max-width: 640px) {
      form {
        border-radius: 0;
        padding: 16px;
      }

      .toolbar {
        justify-content: stretch;
      }

      .transactions-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main>
    <h1>PayPal Orders Dashboard</h1>
    <p class="description">
      Look up individual PayPal orders or captures and run transaction searches across a date range.
      Everything is fetched directly from PayPal’s API—nothing is stored on this server.
    </p>

    <section id="login-section">
      <form id="login-form" autocomplete="off" novalidate>
        <label for="pin">
          Admin PIN
          <input id="pin" name="pin" type="password" inputmode="numeric" autocomplete="current-password"
                 placeholder="Enter the shared admin PIN" required>
        </label>
        <button type="submit">Unlock Dashboard</button>
      </form>
      <div class="login-status" id="login-status" role="status" aria-live="polite"></div>
    </section>

    <section id="dashboard-section" hidden>
      <div class="toolbar">
        <button type="button" class="secondary" id="logout-button">Sign out</button>
      </div>

      <section class="panel" id="lookup-panel">
        <h2>Lookup by ID</h2>
        <form id="lookup-form" autocomplete="off" novalidate>
          <label for="resource-type">
            Resource Type
            <select id="resource-type" name="resource-type">
              <option value="capture">Capture</option>
              <option value="order">Order</option>
            </select>
          </label>

          <label for="resource-id">
            PayPal ID
            <input id="resource-id" name="resource-id" placeholder="Enter capture or order id" required>
          </label>

          <button type="submit">Fetch Details</button>
        </form>

        <div class="status" id="status" role="status" aria-live="polite"></div>

        <div class="response-meta" id="response-meta" hidden>
          <div><strong>Resource:</strong> <span id="meta-name"></span></div>
          <div><strong>Payload keys:</strong> <span id="meta-keys"></span></div>
        </div>

        <pre id="result" hidden></pre>
      </section>

      <section class="panel" id="transactions-panel">
        <h2>Transaction Search</h2>
        <form id="transactions-form" autocomplete="off" novalidate>
          <label for="start-date">
            Start (local time)
            <input id="start-date" name="start-date" type="datetime-local" step="1" required>
          </label>

          <label for="end-date">
            End (local time)
            <input id="end-date" name="end-date" type="datetime-local" step="1" required>
          </label>

          <label for="page">
            Page
            <input id="page" name="page" type="number" inputmode="numeric" min="1" value="1">
          </label>

          <label for="page-size">
            Page Size
            <input id="page-size" name="page-size" type="number" inputmode="numeric" min="1" max="500" value="100">
          </label>

          <label for="transaction-status">
            Transaction Status
            <select id="transaction-status" name="transaction-status">
              <option value="">All statuses</option>
              <option value="S">Completed (S)</option>
              <option value="P">Pending (P)</option>
              <option value="V">Voided (V)</option>
              <option value="D">Denied (D)</option>
              <option value="F">Failed (F)</option>
              <option value="C">Cancelled (C)</option>
            </select>
          </label>

          <button type="submit">Search Transactions</button>
        </form>

        <div class="status" id="transactions-status" role="status" aria-live="polite"></div>

        <div class="response-meta" id="transactions-meta" hidden>
          <div><strong>Range:</strong> <span id="transactions-range"></span></div>
          <div><strong>Page:</strong> <span id="transactions-page"></span></div>
          <div><strong>Returned:</strong> <span id="transactions-count"></span></div>
          <div><strong>Links:</strong> <span id="transactions-links"></span></div>
        </div>

        <div class="transactions-nav" id="transactions-nav" hidden>
          <button type="button" class="secondary" id="transactions-prev" disabled>Previous Page</button>
          <button type="button" class="secondary" id="transactions-next" disabled>Next Page</button>
        </div>

        <div class="transactions-output" id="transactions-output" hidden>
          <div id="transactions-list" class="transactions-grid" hidden></div>
          <details id="transactions-raw" class="transactions-raw" hidden>
            <summary>Raw JSON</summary>
            <pre id="transactions-result"></pre>
          </details>
        </div>
      </section>
    </section>
  </main>

  <script>
    (function () {
      const loginSection = document.getElementById('login-section');
      const dashboardSection = document.getElementById('dashboard-section');
      const loginForm = document.getElementById('login-form');
      const loginStatus = document.getElementById('login-status');
      const logoutButton = document.getElementById('logout-button');
      const lookupForm = document.getElementById('lookup-form');
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      const responseMeta = document.getElementById('response-meta');
      const metaName = document.getElementById('meta-name');
      const metaKeys = document.getElementById('meta-keys');
      const transactionsForm = document.getElementById('transactions-form');
      const transactionsStatus = document.getElementById('transactions-status');
      const transactionsResult = document.getElementById('transactions-result');
      const transactionsMeta = document.getElementById('transactions-meta');
      const transactionsRange = document.getElementById('transactions-range');
      const transactionsCount = document.getElementById('transactions-count');
      const transactionsPage = document.getElementById('transactions-page');
      const transactionsLinks = document.getElementById('transactions-links');
      const transactionsNav = document.getElementById('transactions-nav');
      const transactionsPrevButton = document.getElementById('transactions-prev');
      const transactionsNextButton = document.getElementById('transactions-next');
      const transactionsOutput = document.getElementById('transactions-output');
      const transactionsList = document.getElementById('transactions-list');
      const transactionsRaw = document.getElementById('transactions-raw');

      let lastTransactionParams = null;
      let lastTransactionLinks = { prev: null, next: null };

      function setLoginStatus(message, isError = false) {
        loginStatus.textContent = message || '';
        loginStatus.style.color = isError ? '#f87171' : '#cbd5f5';
      }

      function setStatus(message, isError = false) {
        statusEl.textContent = message || '';
        statusEl.style.color = isError ? '#f87171' : '#cbd5f5';
      }

      function showPayload(payload, resourceId, resourceType) {
        if (!payload) {
          resultEl.hidden = true;
          responseMeta.hidden = true;
          return;
        }

        metaName.textContent = `${resourceType} • ${resourceId}`;
        metaKeys.textContent = Object.keys(payload).join(', ') || '(no keys)';
        responseMeta.hidden = false;

        resultEl.textContent = JSON.stringify(payload, null, 2);
        resultEl.hidden = false;
      }

      function pad2(value) {
        return String(value).padStart(2, '0');
      }

      function formatDateTimeLocalValue(date) {
        return `${date.getFullYear()}-${pad2(date.getMonth() + 1)}-${pad2(date.getDate())}` +
               `T${pad2(date.getHours())}:${pad2(date.getMinutes())}:${pad2(date.getSeconds())}`;
      }

      function toUtcISOString(value) {
        if (!value) {
          return null;
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return null;
        }
        return date.toISOString();
      }

      const TRANSACTION_STATUS_LABELS = {
        S: 'Completed',
        P: 'Pending',
        V: 'Voided',
        D: 'Denied',
        F: 'Failed',
        C: 'Cancelled',
      };

      function formatCurrency(amount) {
        if (!amount) {
          return '—';
        }
        const currency = amount.currency_code || amount.currencyCode || '';
        const rawValue = typeof amount.value === 'number' ? amount.value : Number.parseFloat(amount.value);
        if (Number.isFinite(rawValue)) {
          if (currency) {
            try {
              return new Intl.NumberFormat(undefined, {
                style: 'currency',
                currency,
              }).format(rawValue);
            } catch (err) {
              // ignore and fall back to manual formatting
            }
          }
          return `${currency ? `${currency} ` : ''}${rawValue.toFixed(2)}`;
        }
        if (amount.value !== undefined && amount.value !== null) {
          return currency ? `${currency} ${amount.value}` : String(amount.value);
        }
        return currency || '—';
      }

      function mergeMoney(base, delta) {
        if (!base || !delta) {
          return null;
        }
        const currency = base.currency_code || delta.currency_code || base.currencyCode || delta.currencyCode;
        const baseValue = Number.parseFloat(base.value);
        const deltaValue = Number.parseFloat(delta.value);
        if (!Number.isFinite(baseValue) || !Number.isFinite(deltaValue)) {
          return null;
        }
        return {
          value: baseValue + deltaValue,
          currency_code: currency,
        };
      }

      function formatDateTime(value) {
        if (!value) {
          return '—';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return value;
        }
        return date.toLocaleString(undefined, {
          dateStyle: 'medium',
          timeStyle: 'short',
        });
      }

      function formatFullName(name) {
        if (!name) {
          return '';
        }
        const parts = [];
        if (name.given_name) {
          parts.push(name.given_name);
        }
        if (name.surname) {
          parts.push(name.surname);
        }
        if (!parts.length && name.full_name) {
          parts.push(name.full_name);
        }
        if (!parts.length && name.alternate_full_name) {
          parts.push(name.alternate_full_name);
        }
        return parts.join(' ');
      }

      function appendInfoLine(container, text) {
        if (!container || !text) {
          return;
        }
        const line = document.createElement('span');
        line.textContent = text;
        container.appendChild(line);
      }

      function buildMetaRow(label, value) {
        const row = document.createElement('div');
        row.className = 'transaction-card__meta-row';

        const labelEl = document.createElement('span');
        labelEl.className = 'transaction-card__meta-label';
        labelEl.textContent = label;

        const valueEl = document.createElement('span');
        valueEl.className = 'transaction-card__meta-value';
        valueEl.textContent = value || '—';

        row.append(labelEl, valueEl);
        return row;
      }

      function appendMetaRow(container, label, value) {
        if (!container || value === undefined || value === null || value === '') {
          return;
        }
        container.appendChild(buildMetaRow(label, value));
      }

      function formatStatus(code) {
        if (!code) {
          return 'Unknown';
        }
        const upper = String(code).toUpperCase();
        const label = TRANSACTION_STATUS_LABELS[upper] || 'Unknown';
        return `${label} (${upper})`;
      }

      function setTransactionsStatus(message, isError = false) {
        if (!transactionsStatus) {
          return;
        }
        transactionsStatus.textContent = message || '';
        transactionsStatus.style.color = isError ? '#f87171' : '#cbd5f5';
      }

      function clearTransactionNavigation() {
        lastTransactionParams = null;
        lastTransactionLinks = { prev: null, next: null };
        if (transactionsNav) {
          transactionsNav.hidden = true;
        }
        if (transactionsPrevButton) {
          transactionsPrevButton.disabled = true;
        }
        if (transactionsNextButton) {
          transactionsNextButton.disabled = true;
        }
      }

      function extractPageInfoFromHref(href) {
        if (!href) {
          return null;
        }

        let params = null;
        try {
          const url = new URL(href);
          params = url.searchParams;
        } catch (err) {
          const questionIndex = href.indexOf('?');
          if (questionIndex === -1) {
            return null;
          }
          params = new URLSearchParams(href.substring(questionIndex + 1));
        }

        if (!params) {
          return null;
        }

        const pageRaw = params.get('page');
        if (pageRaw === null) {
          return null;
        }
        const pageParsed = parseInt(pageRaw, 10);
        if (Number.isNaN(pageParsed) || pageParsed < 1) {
          return null;
        }

        const sizeRaw = params.get('page_size') ?? params.get('pageSize');
        let sizeParsed = null;
        if (sizeRaw !== null) {
          const parsed = parseInt(sizeRaw, 10);
          if (!Number.isNaN(parsed) && parsed > 0) {
            sizeParsed = parsed;
          }
        }

        return { page: pageParsed, pageSize: sizeParsed };
      }

      function updateTransactionNavigation(response, params) {
        clearTransactionNavigation();

        if (!transactionsNav || !transactionsPrevButton || !transactionsNextButton) {
          return;
        }

        if (!response || !response.payload) {
          return;
        }

        const links = Array.isArray(response.payload.links) ? response.payload.links : [];
        let hasPrev = false;
        let hasNext = false;

        for (const link of links) {
          if (!link || !link.rel || !link.href) {
            continue;
          }
          const rel = String(link.rel).toLowerCase();
          const pageInfo = extractPageInfoFromHref(link.href);
          if (!pageInfo || !pageInfo.page) {
            continue;
          }

          if (rel === 'prev' || rel === 'previous') {
            if (pageInfo.pageSize == null && typeof params.pageSize === 'number') {
              pageInfo.pageSize = params.pageSize;
            }
            lastTransactionLinks.prev = pageInfo;
            hasPrev = true;
          } else if (rel === 'next') {
            if (pageInfo.pageSize == null && typeof params.pageSize === 'number') {
              pageInfo.pageSize = params.pageSize;
            }
            lastTransactionLinks.next = pageInfo;
            hasNext = true;
          }
        }

        if (hasPrev || hasNext) {
          transactionsNav.hidden = false;
        }

        transactionsPrevButton.disabled = !hasPrev;
        transactionsNextButton.disabled = !hasNext;

        if (hasPrev || hasNext) {
          lastTransactionParams = { ...params };
        }
      }

      function applyTransactionParamsToForm(params) {
        if (!transactionsForm || !params) {
          return;
        }

        const pageField = transactionsForm.elements['page'];
        const pageSizeField = transactionsForm.elements['page-size'];
        const statusField = transactionsForm.elements['transaction-status'];

        if (pageField && typeof params.page === 'number') {
          pageField.value = String(params.page);
        }
        if (pageSizeField && typeof params.pageSize === 'number') {
          pageSizeField.value = String(params.pageSize);
        }
        if (statusField) {
          statusField.value = params.transactionStatus || '';
        }
      }

      function restoreTransactionNavigation(state) {
        if (!state) {
          return;
        }

        const params = state.params ? { ...state.params } : null;
        const prevLink = state.links && state.links.prev ? { ...state.links.prev } : null;
        const nextLink = state.links && state.links.next ? { ...state.links.next } : null;

        lastTransactionParams = params;
        lastTransactionLinks = {
          prev: prevLink,
          next: nextLink,
        };

        const hasPrev = !!(prevLink && prevLink.page);
        const hasNext = !!(nextLink && nextLink.page);

        if (transactionsNav) {
          transactionsNav.hidden = !(hasPrev || hasNext);
        }
        if (transactionsPrevButton) {
          transactionsPrevButton.disabled = !hasPrev;
        }
        if (transactionsNextButton) {
          transactionsNextButton.disabled = !hasNext;
        }

        if (params) {
          applyTransactionParamsToForm(params);
        }
      }

      function renderTransactionCards(payload) {
        if (!transactionsList) {
          return;
        }

        transactionsList.innerHTML = '';

        const createSection = (title) => {
          const section = document.createElement('div');
          section.className = 'transaction-card__section';
          const heading = document.createElement('div');
          heading.className = 'transaction-card__section-title';
          heading.textContent = title;
          const content = document.createElement('div');
          content.className = 'transaction-card__section-content';
          section.append(heading, content);
          return { section, content };
        };

        if (!payload || !Array.isArray(payload.transaction_details) || payload.transaction_details.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'transaction-empty';
          empty.textContent = 'No transactions returned for this search.';
          transactionsList.appendChild(empty);
          transactionsList.hidden = false;
          return;
        }

        for (const detail of payload.transaction_details) {
          const info = detail && detail.transaction_info ? detail.transaction_info : {};
          const payer = detail && detail.payer_info ? detail.payer_info : {};
          const cart = detail && detail.cart_info ? detail.cart_info : {};
          const shipping = detail && detail.shipping_info ? detail.shipping_info : {};

          const card = document.createElement('article');
          card.className = 'transaction-card';

          const header = document.createElement('div');
          header.className = 'transaction-card__header';

          const title = document.createElement('h3');
          title.className = 'transaction-card__title';
          title.textContent = info.transaction_id || '(missing transaction id)';
          header.appendChild(title);

          if (info.transaction_status) {
            const badge = document.createElement('span');
            const statusClass = String(info.transaction_status).toLowerCase();
            badge.className = `transaction-status-badge transaction-status-badge--${statusClass}`;
            badge.textContent = formatStatus(info.transaction_status);
            header.appendChild(badge);
          }

          card.appendChild(header);

          const amountEl = document.createElement('p');
          amountEl.className = 'transaction-card__amount';
          amountEl.textContent = formatCurrency(info.transaction_amount);
          card.appendChild(amountEl);

          const subheader = document.createElement('div');
          subheader.className = 'transaction-card__subheader';

          if (info.transaction_event_code) {
            const eventEl = document.createElement('span');
            eventEl.textContent = `Event ${info.transaction_event_code}`;
            subheader.appendChild(eventEl);
          }

          if (info.instrument_type || info.instrument_sub_type) {
            const instrumentEl = document.createElement('span');
            if (info.instrument_type && info.instrument_sub_type) {
              instrumentEl.textContent = `${info.instrument_type} • ${info.instrument_sub_type}`;
            } else {
              instrumentEl.textContent = info.instrument_type || info.instrument_sub_type;
            }
            subheader.appendChild(instrumentEl);
          }

          if (info.transaction_subject) {
            const subjectEl = document.createElement('span');
            subjectEl.textContent = info.transaction_subject;
            subheader.appendChild(subjectEl);
          }

          if (info.custom_field) {
            const memoEl = document.createElement('span');
            memoEl.textContent = info.custom_field;
            subheader.appendChild(memoEl);
          }

          if (subheader.childElementCount > 0) {
            card.appendChild(subheader);
          }

          const metaContainer = document.createElement('div');
          metaContainer.className = 'transaction-card__meta';

          if (info.transaction_amount) {
            appendMetaRow(metaContainer, 'Gross', formatCurrency(info.transaction_amount));
          }
          if (info.shipping_amount) {
            appendMetaRow(metaContainer, 'Shipping', formatCurrency(info.shipping_amount));
          }
          if (info.fee_amount) {
            appendMetaRow(metaContainer, 'Fee', formatCurrency(info.fee_amount));
          }
          const netAmount = mergeMoney(info.transaction_amount, info.fee_amount);
          if (netAmount) {
            appendMetaRow(metaContainer, 'Net', formatCurrency(netAmount));
          }
          if (info.available_balance) {
            appendMetaRow(metaContainer, 'Available After', formatCurrency(info.available_balance));
          }
          if (info.ending_balance) {
            appendMetaRow(metaContainer, 'Ending Balance', formatCurrency(info.ending_balance));
          }
          if (info.paypal_reference_id) {
            const refText = info.paypal_reference_id_type
              ? `${info.paypal_reference_id} (${info.paypal_reference_id_type})`
              : info.paypal_reference_id;
            appendMetaRow(metaContainer, 'PayPal Reference', refText);
          }
          if (info.protection_eligibility) {
            appendMetaRow(metaContainer, 'Protection', info.protection_eligibility);
          }

          if (metaContainer.childElementCount > 0) {
            card.appendChild(metaContainer);
          }

          const payerSection = createSection('Payer');
          const payerName = formatFullName(payer.payer_name);
          if (payerName) {
            appendInfoLine(payerSection.content, payerName);
          }
          if (payer.email_address) {
            appendInfoLine(payerSection.content, `Email: ${payer.email_address}`);
          }
          if (payer.account_id) {
            appendInfoLine(payerSection.content, `Account: ${payer.account_id}`);
          }
          if (payer.country_code) {
            appendInfoLine(payerSection.content, `Country: ${payer.country_code}`);
          }
          if (payerSection.content.childElementCount > 0) {
            card.appendChild(payerSection.section);
          }

          const shippingSection = createSection('Shipping');
          const shippingName = typeof shipping.name === 'string'
            ? shipping.name
            : formatFullName(shipping.name);
          if (shippingName) {
            appendInfoLine(shippingSection.content, shippingName);
          }
          const shippingAddress = shipping.address || shipping.shipping_address;
          if (shippingAddress) {
            const addressParts = [
              shippingAddress.address_line_1 || shippingAddress.line1,
              shippingAddress.address_line_2 || shippingAddress.line2,
              [shippingAddress.admin_area_2, shippingAddress.admin_area_1]
                .filter(Boolean)
                .join(', '),
              [shippingAddress.postal_code, shippingAddress.country_code]
                .filter(Boolean)
                .join(' '),
            ].filter((part) => part && part.trim());
            if (addressParts.length) {
              appendInfoLine(shippingSection.content, addressParts.join(' • '));
            }
          }
          if (shippingSection.content.childElementCount > 0) {
            card.appendChild(shippingSection.section);
          }

          const items = Array.isArray(cart.item_details) ? cart.item_details : [];
          if (items.length) {
            const itemsSection = createSection('Items');
            const table = document.createElement('table');
            table.className = 'transaction-card__items';

            const thead = document.createElement('thead');
            const headRow = document.createElement('tr');
            ['Item', 'Qty', 'Unit', 'Total'].forEach((heading) => {
              const th = document.createElement('th');
              th.textContent = heading;
              headRow.appendChild(th);
            });
            thead.appendChild(headRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            for (const item of items) {
              const row = document.createElement('tr');

              const nameCell = document.createElement('td');
              nameCell.textContent = item.item_name || item.item_description || item.item_code || '—';
              row.appendChild(nameCell);

              const qtyCell = document.createElement('td');
              qtyCell.textContent = item.item_quantity || '—';
              row.appendChild(qtyCell);

              const unitCell = document.createElement('td');
              unitCell.textContent = formatCurrency(item.item_unit_price || item.item_amount);
              row.appendChild(unitCell);

              const totalCell = document.createElement('td');
              totalCell.textContent = formatCurrency(item.total_item_amount || item.item_amount);
              row.appendChild(totalCell);

              tbody.appendChild(row);
            }

            table.appendChild(tbody);
            itemsSection.content.appendChild(table);
            card.appendChild(itemsSection.section);
          }

          const footer = document.createElement('div');
          footer.className = 'transaction-card__footer';
          if (info.transaction_initiation_date) {
            appendInfoLine(footer, `Initiated: ${formatDateTime(info.transaction_initiation_date)}`);
          }
          if (info.transaction_updated_date) {
            appendInfoLine(footer, `Updated: ${formatDateTime(info.transaction_updated_date)}`);
          }
          if (footer.childElementCount > 0) {
            card.appendChild(footer);
          }

          transactionsList.appendChild(card);
        }

        transactionsList.hidden = false;
      }

      function showTransactionsPayload(response) {
        if (!transactionsMeta) {
          return;
        }

        if (!response || !response.payload) {
          clearTransactionNavigation();
          transactionsMeta.hidden = true;
          if (transactionsResult) {
            transactionsResult.textContent = '';
          }
          if (transactionsOutput) {
            transactionsOutput.hidden = true;
          }
          if (transactionsList) {
            transactionsList.innerHTML = '';
            transactionsList.hidden = true;
          }
          if (transactionsRaw) {
            transactionsRaw.hidden = true;
          }
          return;
        }

        const rangeText = `${response.startDate} → ${response.endDate}`;
        if (transactionsRange) {
          transactionsRange.textContent = rangeText;
        }
        if (transactionsCount) {
          const count = typeof response.returned === 'number' ? response.returned : 0;
          transactionsCount.textContent = `${count} record${count === 1 ? '' : 's'}`;
        }
        if (transactionsPage) {
          const pageLabel = response.page ? response.page : 1;
          const sizeLabel = response.pageSize ? response.pageSize : 100;
          transactionsPage.textContent = `Page ${pageLabel} • Size ${sizeLabel}`;
        }
        if (transactionsLinks) {
          const links = Array.isArray(response.payload.links)
            ? response.payload.links.map((link) => (link && link.rel ? link.rel : '')).filter(Boolean)
            : [];
          transactionsLinks.textContent = links.length ? links.join(', ') : 'none';
        }

        transactionsMeta.hidden = false;
        if (transactionsOutput) {
          transactionsOutput.hidden = false;
        }

        renderTransactionCards(response.payload);

        if (transactionsResult) {
          transactionsResult.textContent = JSON.stringify(response.payload, null, 2);
        }
        if (transactionsRaw) {
          transactionsRaw.hidden = false;
        }
      }

      function prepareDefaultTransactionRange() {
        if (!transactionsForm) {
          return;
        }

        const startField = transactionsForm.elements['start-date'];
        const endField = transactionsForm.elements['end-date'];
        const pageField = transactionsForm.elements['page'];
        const pageSizeField = transactionsForm.elements['page-size'];

        const now = new Date();
        now.setMilliseconds(0);

        if (endField && !endField.value) {
          endField.value = formatDateTimeLocalValue(now);
        }

        if (startField && !startField.value) {
          const start = new Date(now.getTime());
          start.setDate(start.getDate() - 7);
          start.setMilliseconds(0);
          startField.value = formatDateTimeLocalValue(start);
        }

        if (pageField && !pageField.value) {
          pageField.value = '1';
        }

        if (pageSizeField && !pageSizeField.value) {
          pageSizeField.value = '100';
        }
      }

      function showLogin(message = '') {
        loginSection.hidden = false;
        dashboardSection.hidden = true;
        showPayload(null);
        setStatus('');
        if (transactionsForm) {
          transactionsForm.reset();
        }
        setTransactionsStatus('');
        showTransactionsPayload(null);
        if (message) {
          setLoginStatus(message, true);
        } else {
          setLoginStatus('');
        }
        const pinInput = loginForm.elements['pin'];
        if (pinInput) {
          pinInput.focus();
          pinInput.select();
        }
      }

      function showDashboard() {
        loginSection.hidden = true;
        dashboardSection.hidden = false;
        setLoginStatus('');
        if (lookupForm) {
          const idField = lookupForm.elements['resource-id'];
          if (idField && typeof idField.focus === 'function') {
            idField.focus();
            idField.select();
          }
        }
        if (resultEl.hidden) {
          setStatus('Enter a PayPal order or capture id to get started.');
        }
        prepareDefaultTransactionRange();
        if (!transactionsOutput || transactionsOutput.hidden) {
          setTransactionsStatus('Select a time range and run a transaction search.');
        }
      }

      async function refreshSession() {
        try {
          const response = await fetch('/api/admin/session', {
            method: 'GET',
            credentials: 'include',
          });
          if (!response.ok) {
            throw new Error('Session check failed');
          }
        const payload = await response.json();
        if (payload && payload.authenticated) {
          showDashboard();
        } else {
          showLogin();
        }
      } catch (err) {
        console.error('Session check failed', err);
        showLogin('Unable to confirm admin session. Try again in a moment.');
      }
      }

      async function handleLogin(event) {
        event.preventDefault();

        const pinInput = loginForm.elements['pin'];
        const pin = pinInput ? pinInput.value : '';
        if (!pin) {
          setLoginStatus('Enter the admin PIN.', true);
          return;
        }

        setLoginStatus('Verifying PIN…');
        const submitButton = loginForm.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.disabled = true;
        }

        try {
          const response = await fetch('/api/admin/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({ pin }),
          });

          let payload = null;
          try {
            payload = await response.json();
          } catch (err) {
            payload = null;
          }

          if (!response.ok) {
            if (response.status === 401) {
              setLoginStatus('PIN incorrect. Try again.', true);
            } else if (response.status === 429) {
              const waitSeconds = payload && payload.retryAfterSeconds ? payload.retryAfterSeconds : 'a few';
              setLoginStatus(`Too many attempts. Wait ${waitSeconds} seconds and try again.`, true);
            } else if (response.status === 403) {
              setLoginStatus('Origin not allowed for this dashboard.', true);
            } else {
              setLoginStatus('Unable to unlock the dashboard. Try again shortly.', true);
            }
            return;
          }

          loginForm.reset();
          setLoginStatus('Dashboard unlocked.');
          await refreshSession();
        } catch (err) {
          console.error('Login failed', err);
          setLoginStatus('Unexpected error talking to the dashboard API.', true);
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
          }
        }
      }

      async function handleLogout(event) {
        event.preventDefault();
        logoutButton.disabled = true;
        try {
          await fetch('/api/admin/logout', {
            method: 'POST',
            credentials: 'include',
          });
        } catch (err) {
          console.error('Logout failed', err);
        } finally {
          logoutButton.disabled = false;
          showLogin('Signed out.');
        }
      }

      async function lookup(event) {
        event.preventDefault();

        const resourceType = lookupForm.elements['resource-type'].value || 'capture';
        const resourceId = (lookupForm.elements['resource-id'].value || '').trim();

        if (!resourceId) {
          setStatus('Enter a PayPal order or capture id.', true);
          showPayload(null);
          return;
        }

        setStatus('Fetching from PayPal…');
        showPayload(null);
        const submitButton = lookupForm.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.disabled = true;
        }

        try {
          const response = await fetch('/api/admin/paypal/lookup', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              type: resourceType,
              id: resourceId,
            }),
          });

          let payload = null;
          try {
            payload = await response.json();
          } catch (err) {
            payload = null;
          }

          if (response.status === 401) {
            showLogin('Session expired. Enter the admin PIN to continue.');
            return;
          }

          if (response.status === 403) {
            showLogin('Origin not allowed for this dashboard.');
            return;
          }

          if (!response.ok) {
            const reason = payload && payload.error ? payload.error : response.statusText;
            setStatus(`PayPal lookup failed: ${reason}`, true);
            return;
          }

          showPayload(payload.payload, payload.resourceId, payload.resourceType);
          setStatus('Lookup successful.');
        } catch (err) {
          console.error('Lookup failed', err);
          setStatus('Unexpected error talking to the dashboard API.', true);
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
          }
        }
      }

      async function runTransactionSearch(params, triggerButton) {
        if (!params) {
          return;
        }

        if (triggerButton) {
          triggerButton.disabled = true;
        }

        const previousState = {
          params: lastTransactionParams ? { ...lastTransactionParams } : null,
          links: {
            prev: lastTransactionLinks.prev ? { ...lastTransactionLinks.prev } : null,
            next: lastTransactionLinks.next ? { ...lastTransactionLinks.next } : null,
          },
        };

        clearTransactionNavigation();
        setTransactionsStatus('Fetching transaction history…');
        showTransactionsPayload(null);

        try {
          const requestBody = {
            startDate: params.startDate,
            endDate: params.endDate,
            page: params.page,
            pageSize: params.pageSize,
          };
          if (params.transactionStatus) {
            requestBody.transactionStatus = params.transactionStatus;
          }
          if (params.fields) {
            requestBody.fields = params.fields;
          }

          const response = await fetch('/api/admin/paypal/transactions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(requestBody),
          });

          let data = null;
          try {
            data = await response.json();
          } catch (err) {
            data = null;
          }

          if (response.status === 401) {
            showLogin('Session expired. Enter the admin PIN to continue.');
            return;
          }

          if (response.status === 403) {
            showLogin('Origin not allowed for this dashboard.');
            return;
          }

          if (!response.ok) {
            const reason = data && data.error ? data.error : response.statusText;
            setTransactionsStatus(`Transaction search failed: ${reason}`, true);
            if (data && data.body) {
              console.error('Transaction search error body:', data.body);
            }
            restoreTransactionNavigation(previousState);
            return;
          }

          showTransactionsPayload(data);
          updateTransactionNavigation(data, params);

          const count = data && typeof data.returned === 'number' ? data.returned : 0;
          setTransactionsStatus(`Retrieved ${count} transaction${count === 1 ? '' : 's'}.`);
        } catch (err) {
          console.error('Transaction search failed', err);
          setTransactionsStatus('Unexpected error talking to the dashboard API.', true);
          restoreTransactionNavigation(previousState);
        } finally {
          if (triggerButton) {
            triggerButton.disabled = false;
          }
        }
      }

      async function fetchTransactions(event) {
        event.preventDefault();

        if (!transactionsForm) {
          return;
        }

        const submitButton = transactionsForm.querySelector('button[type="submit"]');
        const startField = transactionsForm.elements['start-date'];
        const endField = transactionsForm.elements['end-date'];
        const pageField = transactionsForm.elements['page'];
        const pageSizeField = transactionsForm.elements['page-size'];
        const statusField = transactionsForm.elements['transaction-status'];

        const startIso = toUtcISOString(startField ? startField.value : '');
        const endIso = toUtcISOString(endField ? endField.value : '');

        if (!startIso || !endIso) {
          setTransactionsStatus('Provide both start and end date/time values.', true);
          showTransactionsPayload(null);
          return;
        }

        if (startIso > endIso) {
          setTransactionsStatus('Start date must be before the end date.', true);
          showTransactionsPayload(null);
          return;
        }

        const pageValueRaw = pageField ? pageField.value : '';
        const pageValue = pageValueRaw ? parseInt(pageValueRaw, 10) : 1;
        if (Number.isNaN(pageValue) || pageValue < 1) {
          setTransactionsStatus('Page must be a positive integer.', true);
          showTransactionsPayload(null);
          return;
        }

        const pageSizeRaw = pageSizeField ? pageSizeField.value : '';
        const pageSizeValue = pageSizeRaw ? parseInt(pageSizeRaw, 10) : 100;
        if (Number.isNaN(pageSizeValue) || pageSizeValue < 1 || pageSizeValue > 500) {
          setTransactionsStatus('Page size must be between 1 and 500.', true);
          showTransactionsPayload(null);
          return;
        }

        const statusValue = statusField ? statusField.value : '';

        const params = {
          startDate: startIso,
          endDate: endIso,
          page: pageValue,
          pageSize: pageSizeValue,
        };
        if (statusValue) {
          params.transactionStatus = statusValue;
        }

        await runTransactionSearch(params, submitButton);
      }

      async function changeTransactionPage(direction) {
        if (!lastTransactionParams) {
          return;
        }

        const target =
          direction === 'next' ? lastTransactionLinks.next : lastTransactionLinks.prev;
        if (!target || !target.page) {
          return;
        }

        const params = {
          ...lastTransactionParams,
          page: target.page,
        };
        if (target.pageSize) {
          params.pageSize = target.pageSize;
        }

        applyTransactionParamsToForm(params);
        const triggerButton =
          direction === 'next' ? transactionsNextButton : transactionsPrevButton;
        await runTransactionSearch(params, triggerButton);
      }

      loginForm.addEventListener('submit', handleLogin, { passive: false });
      logoutButton.addEventListener('click', handleLogout, { passive: false });
      lookupForm.addEventListener('submit', lookup, { passive: false });
      if (transactionsForm) {
        transactionsForm.addEventListener('submit', fetchTransactions, { passive: false });
      }
      if (transactionsPrevButton) {
        transactionsPrevButton.addEventListener(
          'click',
          (event) => {
            event.preventDefault();
            changeTransactionPage('prev').catch((err) => {
              console.error('Previous page fetch failed', err);
              setTransactionsStatus('Unable to load previous page from PayPal.', true);
            });
          },
          { passive: false },
        );
      }
      if (transactionsNextButton) {
        transactionsNextButton.addEventListener(
          'click',
          (event) => {
            event.preventDefault();
            changeTransactionPage('next').catch((err) => {
              console.error('Next page fetch failed', err);
              setTransactionsStatus('Unable to load next page from PayPal.', true);
            });
          },
          { passive: false },
        );
      }

      refreshSession();
    })();
  </script>
</body>
</html>
